<template>
  <div v-if="!posts.length" class="d-flex justify-content-center align-items-center cover-all position-absolute">
    <div class="d-flex circle bg-6 p-2">
      <div class="spinner-border text-0" role="status"></div>
    </div>
  </div>
  <TopBar ref="topbar" subreddit="Popular" @params_changed="params_changed" />
  <ul class="list-group border-0 pt-0 mt-3">
    <Post v-for="post in posts" :post="post.data" :hidden="globalHiddenPosts.includes(post.data.permalink)"
      @hide_post="hide_post" class="post-element" :data-permalink="post.data.permalink" :class="{
        'post-not-hidden': !globalHiddenPosts.includes(post.data.permalink),
      }" />
  </ul>
  <div v-if="!scroll_loaded" class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0"
    aria-valuemin="0" aria-valuemax="100">
    <div class="progress-bar"></div>
  </div>
</template>

<script setup>
import { ref, onBeforeMount, onActivated, onDeactivated } from "vue";
import { useRouter } from "vue-router";

import { Geddit } from "/js/geddit.js";
import Post from "./CompactPost.vue";
import TopBar from "./TopBar.vue";

const router = useRouter();
const geddit = new Geddit();
const topbar = ref(null);

const posts = ref([]);
const after = ref(null);

const scroll_loaded = ref(true);

const globalHiddenPosts = ref(
  JSON.parse(localStorage.getItem("hidden_posts")) ?? []
);

async function setup() {
  let response = await geddit.getSubmissions(
    "hot",
    router.currentRoute.value.params.id,
    {
      t: "day",
    }
  );
  if (!response) return;

  posts.value = response.posts;
  after.value = response.after;
}

async function get_posts() {
  let response = await geddit.getSubmissions(
    topbar.value.sort,
    router.currentRoute.value.params.id,
    {
      t: topbar.value.time,
    }
  );
  if (!response) return;

  posts.value = response.posts;
  after.value = response.after;
}

async function scroll() {
  scroll_loaded.value = false;

  let response = await geddit.getSubmissions(
    topbar.value.sort,
    router.currentRoute.value.params.id,
    {
      after: after.value,
      t: topbar.value.time,
    }
  );
  if (!response || !response.posts.length) {
    after.value = null;
    scroll_loaded.value = true;
    return;
  }

  posts.value.push(...response.posts);
  after.value = response.after;

  scroll_loaded.value = true;
}

async function params_changed() {
  posts.value = [];
  after.value = null;
  scroll_loaded.value = true;
  get_posts();
}

async function hide_post(postPermalink, force, silent) {
  // this may cause performance issues, need to test on a daily basis and then move this to a parent container
  let hiddenPosts = JSON.parse(localStorage.getItem("hidden_posts"));
  // init hiddenPosts as an empty array if it doesn't exist
  if (!hiddenPosts) {
    hiddenPosts = [];
  }
  // add post to hiddenPosts array if it doesn't exist
  if (!hiddenPosts.includes(postPermalink)) {
    hiddenPosts.push(postPermalink);
    localStorage.setItem("hidden_posts", JSON.stringify(hiddenPosts));
    // hide post
    if (silent != true) globalHiddenPosts.value = hiddenPosts;
  } else if (force != true) {
    // remove post from hiddenPosts array
    hiddenPosts = hiddenPosts.filter((post) => post !== postPermalink);
    localStorage.setItem("hidden_posts", JSON.stringify(hiddenPosts));
    // unhide post
    globalHiddenPosts.value = hiddenPosts;
  }
}

async function handlePostsInViewport() {
  const postElements = document.querySelectorAll(
    ".post-element.post-not-hidden"
  );

  postElements.forEach((postElement, index) => {
    const rect = postElement.getBoundingClientRect();
    if (rect.bottom < 0) {
      // The post element is above the viewport
      // Add your logic here
      hide_post(postElement.dataset.permalink, true, true);
    }
  });
}

function scroll_handle(el) {
  handlePostsInViewport();
  if (
    el.target.scrollTop + el.target.clientHeight >=
    el.target.scrollHeight - window.innerWidth &&
    scroll_loaded.value &&
    after.value
  ) {
    scroll();
  }
}

onBeforeMount(() => {
  if (!router.currentRoute.value.params.id) {
    router.back();
    return;
  }

  setup();
});

onActivated(() => {
  // Add the scroll event listener
  let view = document.querySelector(".content-view");
  view.addEventListener("scroll", scroll_handle);

  // Scroll to the last position
  let pages = JSON.parse(localStorage.getItem("pages"));
  let this_page = pages.find((page) => page.path == window.location.pathname);
  if (this_page) {
    document.querySelector(".content-view").scrollTop = parseInt(
      this_page.scroll
    );
  }
});

onDeactivated(() => {
  // Disable scroll event listener
  let view = document.querySelector(".content-view");
  view.removeEventListener("scroll", scroll_handle);
});
</script>
